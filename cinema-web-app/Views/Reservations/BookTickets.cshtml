@model cinema_web_app.Models.ReservationViewModel

@{
ViewData["Title"] = "Book Tickets";
}

<div class="container mt-5">
    <h1 class="mb-4">Book Tickets</h1>

    <form asp-action="BookTickets" method="post">
        <input type="hidden" asp-for="MovieId" />
        <input type="hidden" asp-for="CinemaId" />
        <input type="hidden" asp-for="ScreeningId" />
        <input type="hidden" asp-for="ScreeningDate" />

        <div class="row">
            <!-- Step 1: Select Movie -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Select Movie</h5>
                    </div>
                    <div class="card-body">
                        <select id="movieSelect" class="form-control" asp-for="MovieId" asp-items="ViewBag.Movies">
                            <option value="">Select a movie</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Select Cinema -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Select Cinema</h5>
                    </div>
                    <div class="card-body">
                        <select id="cinemaSelect" class="form-control" disabled>
                            <option value="">Select a cinema</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 3: Select Screening Date and Time -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Select Screening</h5>
                    </div>
                    <div class="card-body">
                        <select id="screeningSelect" class="form-control" disabled>
                            <option value="">Select a screening</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Step 4: Choose Number of Seats -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Choose Seats</h5>
                    </div>
                    <div class="card-body">
                        <input type="number" id="noOfSeats" name="NoOfSeats" class="form-control" min="1" max="8" value="1" disabled />
                    </div>
                </div>
            </div>

            <!-- Summary and Submit -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Summary</h5>
                    </div>
                    <div class="card-body">
                        <p id="movieSummary">Movie: N/A</p>
                        <p id="cinemaSummary">Cinema: N/A</p>
                        <p id="screeningSummary">Screening: N/A</p>
                        <p id="seatsSummary">Seats: N/A</p>
                    </div>
                    <div class="card-footer text-right">
                        <button type="submit" class="btn btn-primary" id="bookButton" disabled>Book Now</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
<script>
    $(document).ready(function () {
        $('#movieSelect').change(function () {
            var movieId = $(this).val();
            $('#MovieId').val(movieId);
            if (movieId) {
                $.ajax({
                    url: '@Url.Action("GetCinemasForMovie", "Reservations")',
                    data: { movieId: movieId },
                    success: function (data) {
                        var cinemaSelect = $('#cinemaSelect');
                        cinemaSelect.empty().append('<option value="">Select a cinema</option>');
                        $.each(data, function (i, cinema) {
                            cinemaSelect.append('<option value="' + cinema.id + '">' + cinema.name + '</option>');
                        });
                        cinemaSelect.prop('disabled', false);
                    }
                });
            }
        });

        $('#cinemaSelect').change(function () {
            var cinemaId = $(this).val();
            var movieId = $('#movieSelect').val();
            $('#CinemaId').val(cinemaId);
            if (cinemaId) {
                $.ajax({
                    url: '@Url.Action("GetScreeningsForCinemaAndMovie", "Reservations")',
                    data: { cinemaId: cinemaId, movieId: movieId },
                    success: function (data) {
                        var screeningSelect = $('#screeningSelect');
                        screeningSelect.empty().append('<option value="">Select a screening</option>');
                        $.each(data, function (i, screening) {
                            screeningSelect.append('<option value="' + screening.id + '" data-date="' + screening.dateTime + '" data-room="' + screening.screeningRoom + '">' + screening.dateTime + ' - ' + screening.screeningRoom + '</option>');
                        });
                        screeningSelect.prop('disabled', false);
                    }
                });
            }
        });

        $('#screeningSelect').change(function () {
            var screeningId = $(this).val();
            var screeningDate = $('#screeningSelect option:selected').data('date');
            var screeningRoom = $('#screeningSelect option:selected').data('room');
            $('#ScreeningId').val(screeningId);
            $('#ScreeningDate').val(screeningDate);
            if (screeningId) {
                $.ajax({
                    url: '@Url.Action("GetRemainingSeats", "Reservations")',
                    data: { screeningId: screeningId },
                    success: function (data) {
                        $('#noOfSeats').prop('max', data).prop('disabled', false);
                        updateSummary();
                    }
                });
            }
        });

        $('#noOfSeats').change(function () {
            updateSummary();
        });

        function updateSummary() {
            $('#movieSummary').text('Movie: ' + $('#movieSelect option:selected').text());
            $('#cinemaSummary').text('Cinema: ' + $('#cinemaSelect option:selected').text());
            $('#screeningSummary').text('Screening: ' + $('#screeningSelect option:selected').data('date') + ' - ' + $('#screeningSelect option:selected').data('room'));
            $('#seatsSummary').text('Seats: ' + $('#noOfSeats').val());
            $('#bookButton').prop('disabled', false);
        }
    });
</script>
}
